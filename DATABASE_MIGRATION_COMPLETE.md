# ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ PostgreSQL –∑–∞–≤–µ—Ä—à–µ–Ω–∞

## üéØ –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. ‚ùå –ü—Ä–æ–±–ª–µ–º–∞: –î–∞–Ω–Ω—ã–µ —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –Ω–∞ Railway
**–†–µ—à–µ–Ω–∏–µ:** –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ç–µ–ø–µ—Ä—å —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ PostgreSQL —á–µ—Ä–µ–∑ Prisma
- ‚ùå –£–±—Ä–∞–Ω–∞ file-persistence (—Ñ–∞–π–ª—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ Railway)
- ‚ùå –£–±—Ä–∞–Ω—ã in-memory –º–∞—Å—Å–∏–≤—ã (tempSpawnPoints, userInventory, userCards)
- ‚úÖ –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å —á–µ—Ä–µ–∑ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

### 2. ‚ùå –ü—Ä–æ–±–ª–µ–º–∞: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–µ —Ü–∏—Ñ—Ä—ã
**–†–µ—à–µ–Ω–∏–µ:** –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ–ø–µ—Ä—å –±–µ—Ä—ë—Ç—Å—è –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ë–î
- ‚úÖ `/api/user/stats` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `getUserStats()` –∏–∑ db-storage
- ‚úÖ –†–µ–∞–ª—å–Ω—ã–π –ø–æ–¥—Å—á—ë—Ç —á–µ—Ä–µ–∑ Prisma:
  - `totalShards`: `UserShard.count({ where: { userId, used: false } })`
  - `totalCards`: `UserCard.count({ where: { userId, minted: false } })`

### 3. ‚ùå –ü—Ä–æ–±–ª–µ–º–∞: –ù—É–∂–µ–Ω —Ä–µ–∞–ª—å–Ω—ã–π –º–∏–Ω—Ç, –Ω–µ mock
**–†–µ—à–µ–Ω–∏–µ:** Mock mint —É–¥–∞–ª—ë–Ω, —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ TON blockchain
- ‚ùå –£–¥–∞–ª—ë–Ω `/api/mint/mock`
- ‚úÖ –†–µ–∞–ª—å–Ω—ã–π TON –º–∏–Ω—Ç —á–µ—Ä–µ–∑ `/api/mint/ton` —Å TonConnect
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–ª—è TON blockchain

### 4. ‚ùå –ü—Ä–æ–±–ª–µ–º–∞: –ö–∞—Ä—Ç—ã –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ –º–∏–Ω—Ç–∞
**–†–µ—à–µ–Ω–∏–µ:** –ö–∞—Ä—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è –∏–∑ –ë–î
- ‚úÖ –§—É–Ω–∫—Ü–∏—è `deleteCardAfterMint(cardId, tokenId, txHash)` –≤ db-storage
- ‚úÖ –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ PUT `/api/mint/ton` –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- ‚úÖ `prisma.userCard.delete()` - –∫–∞—Ä—Ç–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª—è–µ—Ç—Å—è

### 5. ‚úÖ –ê–≤—Ç–æ-–ª–æ–≥–∏–Ω —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ `getUserSession()` –≤ `/lib/user-session.ts`
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

---

## üì¶ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### `/lib/db-storage.ts` (331 —Å—Ç—Ä–æ–∫)
–ü–æ–ª–Ω–∞—è –∑–∞–º–µ–Ω–∞ file-persistence. –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Prisma:

```typescript
// –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
export async function getActiveSpawnPoints()
export async function createSpawnPoint(shardId, latitude, longitude, radius?, expiresAt?)
export async function collectShard(userId, shardId)
export async function getUserInventory(userId)
export async function craftCard(userId, shardIds)
export async function deleteCardAfterMint(userCardId, tokenId, txHash)
export async function getOrCreateUser(nickname)
export async function getUserStats(userId)
export async function transferCard(userCardId, fromUserId, toNickname)
```

---

## üîÑ –ü–µ—Ä–µ–ø–∏—Å–∞–Ω–Ω—ã–µ API

### 1. `/app/api/checkin/route.ts`
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `collectShard()` –∏–∑ db-storage
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤ –ë–î

### 2. `/app/api/inventory/route.ts`
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `getUserInventory()` –∏–∑ db-storage
- ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –æ—Å–∫–æ–ª–∫–∏
- ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–µ–∑–∞–º–∏–Ω—á–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã

### 3. `/app/api/craft/route.ts`
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `craftCard()` –∏–∑ db-storage
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è 3 –æ—Å–∫–æ–ª–∫–æ–≤ (A+B+C)
- ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: —Å–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã + –ø–æ–º–µ—Ç–∫–∞ –æ—Å–∫–æ–ª–∫–æ–≤
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–æ–≤ (totalCards, mintedCount)

### 4. `/app/api/user/stats/route.ts`
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `getUserStats()` –∏–∑ db-storage
- ‚úÖ –†–µ–∞–ª—å–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –∏–∑ –ë–î
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### 5. `/app/api/transfer/route.ts`
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `transferCard()` –∏–∑ db-storage
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

### 6. `/app/api/spawn-points/route.ts`
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `getActiveSpawnPoints()` –∏–∑ db-storage
- ‚úÖ –§–∏–ª—å—Ç—Ä –ø–æ –∞–∫—Ç–∏–≤–Ω—ã–º –∏ –Ω–µ –∏—Å—Ç—ë–∫—à–∏–º
- ‚úÖ –í–∫–ª—é—á–∞–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (shard, card)

### 7. `/app/api/mint/ton/route.ts`
- ‚úÖ POST: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è TON —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –≤ –ë–î
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞ —á–µ—Ä–µ–∑ Prisma
- ‚úÖ PUT: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –º–∏–Ω—Ç–∞
- ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã —á–µ—Ä–µ–∑ `deleteCardAfterMint()`

### 8. `/app/inventory/page.tsx`
- ‚úÖ handleMint —Ç–µ–ø–µ—Ä—å –≤—ã–∑—ã–≤–∞–µ—Ç `/api/mint/ton` (—Ä–µ–∞–ª—å–Ω—ã–π)
- ‚úÖ –£–±—Ä–∞–Ω –≤—ã–∑–æ–≤ mock API

---

## üóëÔ∏è –£–¥–∞–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

```bash
lib/file-persistence.ts      # ‚ùå –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ Railway
lib/spawn-storage.ts          # ‚ùå –ó–∞–º–µ–Ω—ë–Ω –Ω–∞ db-storage.ts
app/api/mint/mock/route.ts    # ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç—Ä–µ–±—É–µ—Ç —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–π –º–∏–Ω—Ç
```

---

## üóÑÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã:
```sql
User
  - id (uuid)
  - nickname (unique)
  - totalShards (int)
  - totalCards (int)

UserShard
  - id (uuid)
  - userId -> User
  - shardId -> Shard
  - collectedAt (timestamp)
  - used (boolean)

UserCard
  - id (uuid)
  - userId -> User
  - cardId -> Card
  - assembledAt (timestamp)
  - minted (boolean)
  - tokenId (string?)

SpawnPoint
  - id (uuid)
  - shardId -> Shard
  - latitude, longitude
  - radius
  - active (boolean)
  - expiresAt (timestamp?)
```

### –ü–∞—Ç—Ç–µ—Ä–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
```typescript
// 1. –ü–æ–ª—É—á–∏—Ç—å/—Å–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const user = await getOrCreateUser(nickname)

// 2. –°–æ–±—Ä–∞—Ç—å –æ—Å–∫–æ–ª–æ–∫
await collectShard(user.id, shardId)

// 3. –°–∫—Ä–∞—Ñ—Ç–∏—Ç—å –∫–∞—Ä—Ç—É
await craftCard(user.id, [shardId1, shardId2, shardId3])

// 4. –ó–∞–º–∏–Ω—Ç–∏—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å
await deleteCardAfterMint(userCardId, tokenId, txHash)
```

---

## üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –õ–æ–∫–∞–ª—å–Ω–æ:
```bash
# 1. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ë–î –∑–∞–ø—É—â–µ–Ω–∞
DATABASE_URL="postgresql://..."

# 2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
npx prisma migrate deploy

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å dev
pnpm dev
```

### –ù–∞ Railway:
```bash
# 1. –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
DATABASE_URL=postgresql://...

# 2. Deploy
railway up

# 3. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
npx prisma migrate deploy
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É:
1. ‚úÖ –°–æ–±—Ä–∞—Ç—å –æ—Å–∫–æ–ª–∫–∏ ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î
2. ‚úÖ –°–∫—Ä–∞—Ñ—Ç–∏—Ç—å –∫–∞—Ä—Ç—É ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î
3. ‚úÖ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É ‚Üí —Ü–∏—Ñ—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ
4. ‚úÖ –ó–∞–º–∏–Ω—Ç–∏—Ç—å –∫–∞—Ä—Ç—É ‚Üí –∫–∞—Ä—Ç–∞ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ –ë–î
5. ‚úÖ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä ‚Üí –¥–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞–ª–∏—Å—å

---

## üìù –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
- –í—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ PostgreSQL (–Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è)
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ –ë–î (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ü–∏—Ñ—Ä—ã)
- –†–µ–∞–ª—å–Ω—ã–π TON –º–∏–Ω—Ç (–Ω–µ mock)
- –ö–∞—Ä—Ç—ã —É–¥–∞–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ –º–∏–Ω—Ç–∞
- –ê–≤—Ç–æ-–ª–æ–≥–∏–Ω —á–µ—Ä–µ–∑ localStorage

### ‚ö†Ô∏è –ß—Ç–æ –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –Ω–∞ Railway:
```env
DATABASE_URL=postgresql://user:pass@host:port/db
NEXT_PUBLIC_TON_COLLECTION_ADDRESS=EQC...
```

### üîß –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ë–î:
```bash
# –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
npx prisma migrate dev --name migration_name

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
npx prisma migrate deploy

# –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Prisma Client
npx prisma generate

# –û—Ç–∫—Ä—ã—Ç—å Prisma Studio
npx prisma studio
```

---

## ‚úÖ –í—Å–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã

1. ‚úÖ "–Ω—É–∂–µ–Ω —Ä–µ–∞–ª—å–Ω—ã–π –º–∏–Ω—Ç, –Ω–∏–∫–∞–∫–æ–≥–æ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ" - mock —É–¥–∞–ª—ë–Ω, —Ä–∞–±–æ—Ç–∞–µ—Ç TON
2. ‚úÖ "—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –æ—Å–∫–æ–ª–∫–∞–º –Ω–µ–≤–µ—Ä–Ω–∞—è" - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ getUserStats()
3. ‚úÖ "–≤—Å–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–∞ —Ö–æ—Å—Ç–µ" - –¥–∞–Ω–Ω—ã–µ –≤ PostgreSQL
4. ‚úÖ "–ø—É—Å—Ç—å –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —Å –∞–∫–∫–∞—É–Ω—Ç–∞" - –∞–≤—Ç–æ-–ª–æ–≥–∏–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç
5. ‚úÖ "–ø–æ—Å–ª–µ –º–∏–Ω—Ç–∞ –∫–∞—Ä—Ç–∞ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–ø–∞–¥–∞—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞" - deleteCardAfterMint()
6. ‚úÖ "–°–£–ü–ê–ë–ï–ô–ó –í–û–û–ë–©–ï –ù–ï –ù–£–ñ–ù–ê!" - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ Prisma + PostgreSQL
7. ‚úÖ "–¥–∞–π —á–∏—Å—Ç—ã–π –∫–æ–¥" - —á–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, –±–µ–∑ –æ—à–∏–±–æ–∫ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏

---

## üéâ –ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é!

–í—Å–µ API –ø–µ—Ä–µ–ø–∏—Å–∞–Ω—ã, mock —É–¥–∞–ª—ë–Ω, –¥–∞–Ω–Ω—ã–µ –≤ –ë–î, –æ—à–∏–±–æ–∫ –Ω–µ—Ç. –ú–æ–∂–Ω–æ –¥–µ–ø–ª–æ–∏—Ç—å –Ω–∞ Railway! üöÄ
